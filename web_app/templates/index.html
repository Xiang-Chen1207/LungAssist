<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能肺结节诊断系统 v3.0 Pro</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --accent: #38bdf8;
            --accent-hover: #0ea5e9;
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --border: #334155;
            --success: #22c55e;
            --doctor-color: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            height: 60px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
        }
        .brand { font-size: 18px; font-weight: 600; color: var(--accent); display: flex; align-items: center; gap: 10px; }

        /* Main Grid */
        main {
            flex: 1;
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            gap: 1px;
            background: var(--border);
            overflow: hidden; /* 防止撑开页面 */
        }

        .sidebar, .results-panel { background: var(--bg-dark); padding: 20px; display: flex; flex-direction: column; gap: 20px; z-index: 2; }

        /* Mode Tabs */
        .mode-tabs { display: flex; background: var(--bg-panel); border-radius: 8px; padding: 4px; border: 1px solid var(--border); }
        .mode-tab { flex: 1; text-align: center; padding: 8px; font-size: 13px; cursor: pointer; border-radius: 6px; color: var(--text-dim); transition: 0.2s; }
        .mode-tab.active { background: var(--accent); color: #0f172a; font-weight: bold; }

        /* Buttons */
        .tool-group h3 { font-size: 12px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 8px; letter-spacing: 0.5px; }
        .btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-main); cursor: pointer; margin-bottom: 8px; transition: 0.2s; font-size: 14px; }
        .btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
        .btn.primary { background: var(--accent); color: #000; border: none; font-weight: 600; }
        .btn.primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn.active { background: rgba(56, 189, 248, 0.2); border-color: var(--accent); color: var(--accent); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Workspace (Center) */
        .workspace-area {
            background: #000;
            display: flex;
            flex-direction: column; /* 垂直排列：画布在上，画廊在下 */
            position: relative;
            overflow: hidden;
        }

        .canvas-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }

        .canvas-container {
            position: relative;
            width: 512px;
            height: 512px;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            background: #000;
        }
        canvas { position: absolute; top: 0; left: 0; }
        #layerImg { z-index: 10; }
        #layerDraw { z-index: 20; }
        #layerAI { z-index: 30; pointer-events: none; transition: opacity 0.3s; }

        /* 底部图像处理画廊 (新增) */
        .process-gallery {
            height: 0; /* 默认隐藏 */
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            overflow-x: auto;
            transition: height 0.3s ease;
        }
        .process-gallery.show { height: 140px; }

        .step-card {
            min-width: 100px;
            height: 110px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        .step-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .step-card.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(56,189,248,0.3); }
        
        .step-img { flex: 1; width: 100%; object-fit: cover; background: #000; }
        .step-label { height: 24px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: var(--text-dim); background: rgba(0,0,0,0.3); }

        /* Status & Loading */
        .status-box { padding: 15px; border-radius: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); margin-top: 10px; display: none; }
        #loadingMask { position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 50; display: none; align-items: center; justify-content: center; color: white; flex-direction: column; gap: 10px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #fff; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        <span>LungAI Assist Pro</span>
    </div>
    <div style="font-size: 12px; color: var(--text-dim);">U-Net Model v1.2</div>
</header>

<main>
    <div class="sidebar">
        <div class="tool-group">
            <h3>工作模式</h3>
            <div class="mode-tabs">
                <div class="mode-tab active" onclick="switchMode('auto')" id="tabAuto">AI 全自动</div>
                <div class="mode-tab" onclick="switchMode('assist')" id="tabAssist">专家协作+解析</div>
            </div>
        </div>

        <div class="tool-group">
            <h3>1. 影像导入</h3>
            <button class="btn" onclick="document.getElementById('fileInput').click()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                上传 CT
            </button>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>

        <div class="tool-group" id="drawTools" style="display: none;">
            <h3>2. 人工复核</h3>
            <button class="btn active" id="btnPen" onclick="setTool('pen')">画笔 (标红)</button>
            <button class="btn" id="btnEraser" onclick="setTool('eraser')">橡皮擦</button>
            <button class="btn" onclick="clearDraw()">清除标注</button>
        </div>

        <div style="margin-top: auto;">
            <button class="btn primary" id="btnRun" disabled onclick="runAnalysis()">
                开始分析
            </button>
        </div>
    </div>

    <div class="workspace-area">
        <div class="canvas-wrapper">
            <div class="canvas-container" id="canvasContainer" style="display:none;">
                <canvas id="layerImg" width="512" height="512"></canvas>
                <canvas id="layerDraw" width="512" height="512"></canvas>
                <canvas id="layerAI" width="512" height="512"></canvas>
                
                <div id="loadingMask">
                    <div class="spinner"></div>
                    <span>计算中...</span>
                </div>
            </div>
            <div id="emptyState" style="color: #64748b;">请上传图片</div>
        </div>

        <div class="process-gallery" id="processGallery">
            </div>
    </div>

    <div class="results-panel">
        <div class="tool-group">
            <h3>图例</h3>
            <div class="legend-item" style="display:flex; gap:10px; align-items:center; font-size:14px;"><span style="width:12px; height:12px; background:#ef4444; border-radius:50%;"></span> 医生标注</div>
            <div class="legend-item" style="display:flex; gap:10px; align-items:center; font-size:14px;"><span style="width:12px; height:12px; background:#22c55e; border-radius:50%;"></span> AI 预测</div>
        </div>

        <div class="tool-group">
            <h3>图层控制</h3>
            <label style="display:flex;gap:8px;cursor:pointer;"><input type="checkbox" id="chkShowAI" checked onchange="toggleLayer('ai')"> 显示 AI</label>
            <label style="display:flex;gap:8px;cursor:pointer;margin-top:8px;"><input type="checkbox" id="chkShowDoc" checked onchange="toggleLayer('doc')"> 显示 医生</label>
        </div>

        <div class="status-box" id="resultBox">
            <h4 style="color: var(--success); margin-bottom: 5px;">分析完成</h4>
            <p id="resultText" style="font-size: 13px; color: var(--text-dim);"></p>
        </div>
    </div>
</main>

<script>
    let currentMode = 'auto';
    let currentFile = null;
    let originalImageSrc = null; // 保存原始图片的Base64，用于从滤镜预览切回
    let isDrawing = false;
    let tool = 'pen';

    const ctxImg = document.getElementById('layerImg').getContext('2d');
    const ctxDraw = document.getElementById('layerDraw').getContext('2d');
    const ctxAI = document.getElementById('layerAI').getContext('2d');

    // 模式切换
    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('tabAuto').className = `mode-tab ${mode==='auto'?'active':''}`;
        document.getElementById('tabAssist').className = `mode-tab ${mode==='assist'?'active':''}`;
        
        // 显示/隐藏工具
        document.getElementById('drawTools').style.display = mode === 'assist' ? 'block' : 'none';
        document.getElementById('layerDraw').style.display = mode === 'assist' ? 'block' : 'none';
        
        // 显示/隐藏底部画廊
        const gallery = document.getElementById('processGallery');
        if (mode === 'assist' && gallery.innerHTML.trim() !== "") {
            gallery.classList.add('show');
        } else {
            gallery.classList.remove('show');
        }
    }

    // 图片上传
    document.getElementById('fileInput').addEventListener('change', (e) => {
        if (!e.target.files.length) return;
        currentFile = e.target.files[0];
        
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('canvasContainer').style.display = 'block';
        document.getElementById('btnRun').disabled = false;
        document.getElementById('resultBox').style.display = 'none';
        
        // 清理旧数据
        document.getElementById('processGallery').innerHTML = '';
        document.getElementById('processGallery').classList.remove('show');

        const reader = new FileReader();
        reader.onload = (evt) => {
            originalImageSrc = evt.target.result;
            loadBase64ToCanvas(originalImageSrc, ctxImg);
        };
        reader.readAsDataURL(currentFile);
        
        clearDraw();
        ctxAI.clearRect(0,0,512,512);
    });

    // 运行分析
    async function runAnalysis() {
        if (!currentFile) return;
        const loading = document.getElementById('loadingMask');
        loading.style.display = 'flex';

        const formData = new FormData();
        formData.append('image', currentFile);

        try {
            const res = await fetch('/process', { method: 'POST', body: formData });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);

            // 1. 绘制 AI Mask (透明 PNG)
            const aiImg = new Image();
            aiImg.onload = () => {
                ctxAI.clearRect(0,0,512,512);
                ctxAI.drawImage(aiImg, 0, 0, 512, 512);
            };
            aiImg.src = 'data:image/png;base64,' + data.ai_mask_png;

            // 2. 结果文本
            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('resultText').innerText = data.stats.detected ? 
                `疑似结节 (置信度: ${data.stats.confidence})` : "无显著异常";

            // 3. 生成底部处理流程画廊
            const gallery = document.getElementById('processGallery');
            gallery.innerHTML = ''; // 清空

            // 插入原始图卡片
            addGalleryItem(gallery, originalImageSrc, "原始图像", true);

            // 插入步骤图
            for (const [name, b64] of Object.entries(data.steps)) {
                // name 格式可能是 "1_Gray", 处理一下显示文本
                const label = name.split('_')[1] || name; 
                addGalleryItem(gallery, 'data:image/png;base64,'+b64, label);
            }

            // 如果是协助模式，自动展开画廊
            if (currentMode === 'assist') {
                gallery.classList.add('show');
            }

        } catch (e) {
            alert(e.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    // 辅助：添加画廊卡片
    function addGalleryItem(container, src, label, isOriginal=false) {
        const div = document.createElement('div');
        div.className = 'step-card' + (isOriginal ? ' active' : '');
        div.onclick = function() {
            // 切换主画布显示
            loadBase64ToCanvas(src, ctxImg);
            // 高亮当前卡片
            document.querySelectorAll('.step-card').forEach(c => c.classList.remove('active'));
            div.classList.add('active');
        };

        const img = document.createElement('img');
        img.className = 'step-img';
        img.src = src;

        const span = document.createElement('span');
        span.className = 'step-label';
        span.innerText = label;

        div.appendChild(img);
        div.appendChild(span);
        container.appendChild(div);
    }

    function loadBase64ToCanvas(src, ctx) {
        const img = new Image();
        img.onload = () => {
            ctx.clearRect(0,0,512,512);
            ctx.drawImage(img, 0, 0, 512, 512);
        };
        img.src = src;
    }

    // 画笔功能
    const drawCanvas = document.getElementById('layerDraw');
    ctxDraw.lineCap = 'round'; ctxDraw.lineWidth = 3; ctxDraw.strokeStyle = '#ef4444';

    drawCanvas.addEventListener('mousedown', startDraw);
    drawCanvas.addEventListener('mousemove', draw);
    drawCanvas.addEventListener('mouseup', () => isDrawing=false);
    drawCanvas.addEventListener('mouseout', () => isDrawing=false);

    function startDraw(e) {
        if(currentMode !== 'assist') return;
        isDrawing=true; 
        ctxDraw.beginPath();
        draw(e);
    }
    function draw(e) {
        if(!isDrawing || currentMode!=='assist') return;
        const rect = drawCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        if(tool==='pen') {
            ctxDraw.globalCompositeOperation='source-over';
            ctxDraw.lineTo(x,y); ctxDraw.stroke(); ctxDraw.beginPath(); ctxDraw.moveTo(x,y);
        } else {
            ctxDraw.globalCompositeOperation='destination-out';
            ctxDraw.arc(x,y,10,0,Math.PI*2); ctxDraw.fill();
        }
    }

    // 工具函数
    function setTool(t) { tool=t; document.getElementById('btnPen').className = t==='pen'?'btn active':'btn'; document.getElementById('btnEraser').className = t==='eraser'?'btn active':'btn'; }
    function clearDraw() { ctxDraw.clearRect(0,0,512,512); }
    function toggleLayer(l) { 
        if(l==='ai') document.getElementById('layerAI').style.opacity = document.getElementById('chkShowAI').checked?1:0;
        if(l==='doc') document.getElementById('layerDraw').style.opacity = document.getElementById('chkShowDoc').checked?1:0;
    }

    switchMode('auto'); // init
</script>
</body>
</html>